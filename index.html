<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>نموذج الطلب</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#f3f4f6;--card:#fff;--text:#111827;--sub:#6b7280;--border:#e5e7eb;--r:18px;}
    *{box-sizing:border-box}
    body{margin:0;font-family:Tajawal,system-ui;background:var(--bg);color:var(--text);padding:18px}
    .wrap{max-width:680px;margin:0 auto}
    .card{background:var(--card);border:1px solid rgba(17,24,39,.08);border-radius:var(--r);padding:16px;box-shadow:0 16px 30px rgba(0,0,0,.08)}
    h1{margin:0 0 6px;font-size:18px;font-weight:900}
    p{margin:0 0 14px;color:var(--sub);font-size:13px;line-height:1.7}
    .row{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}
    label{font-weight:900;font-size:13px}
    input,select,textarea{
      border:1px solid var(--border);border-radius:14px;padding:12px 12px;font-family:inherit;font-size:14px;outline:none;
      background:#fff
    }
    input:focus,select:focus,textarea:focus{border-color:#111827}
    .btn{
      width:100%;border:0;border-radius:14px;padding:12px 14px;font-weight:900;cursor:pointer;font-family:inherit;
      background:#111827;color:#fff
    }
    .msg{margin-top:12px;padding:12px;border-radius:14px;border:1px solid var(--border);background:#fafafa;display:none}
    .ok{border-color:#bbf7d0;background:#ecfdf5}
    .err{border-color:#fecaca;background:#fef2f2}
    .muted{color:var(--sub)}
    a{color:#111827;font-weight:900}
    code{direction:ltr;unicode-bidi:bidi-override}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 id="formTitle">نموذج الطلب</h1>
      <p id="formDesc">يرجى تعبئة البيانات التالية.</p>

      <form id="dynamicForm"></form>

      <button class="btn" id="submitBtn" type="button">إرسال</button>

      <div class="msg" id="msgBox"></div>
    </div>
  </div>

<script>
  const formEl = document.getElementById("dynamicForm");
  const msgBox = document.getElementById("msgBox");
  const submitBtn = document.getElementById("submitBtn");

  let currentForm = null;
  let currentFields = [];

  function showMsg(type, html){
    msgBox.className = "msg " + (type === "ok" ? "ok" : "err");
    msgBox.style.display = "block";
    msgBox.innerHTML = html;
  }

  function esc(s){
    return String(s||"").replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  }

  async function loadForm(){
    msgBox.style.display = "none";
    formEl.innerHTML = `<div class="muted">جارٍ تحميل الحقول...</div>`;

    // حالياً نستخدم الفورم الافتراضي (id=1) من /api/form
    const res = await fetch("/api/form");
    const data = await res.json();

    if(!res.ok || !data.ok){
      formEl.innerHTML = "";
      showMsg("err", `تعذر تحميل النموذج. <br><span class="muted">${esc(data?.error || "Unknown")}</span>`);
      submitBtn.disabled = true;
      return;
    }

    currentForm = data.form;
    currentFields = data.fields || [];

    document.getElementById("formTitle").textContent = currentForm?.name || "نموذج الطلب";

    renderFields(currentFields);
  }

  function renderFields(fields){
    formEl.innerHTML = fields.map(f => {
      const key = f.options?.key || (f.options_json ? JSON.parse(f.options_json).key : "");
      const required = Number(f.required) === 1 ? "required" : "";
      const label = f.label || key || "حقل";

      // أنواع مدعومة مبدئياً: text / tel / number
      let inputAttrs = "";
      let type = (f.field_type || "text").toLowerCase();

      if(type === "number"){
        inputAttrs = `min="1" inputmode="numeric"`;
      }
      if(type === "tel"){
        inputAttrs = `inputmode="tel"`;
      }

      return `
        <div class="row">
          <label for="${esc(key)}">${esc(label)} ${required ? '<span class="muted">(مطلوب)</span>' : ''}</label>
          <input id="${esc(key)}" name="${esc(key)}" type="${esc(type)}" ${required} ${inputAttrs} />
        </div>
      `;
    }).join("");
  }

  async function submitForm(){
    msgBox.style.display = "none";
    submitBtn.disabled = true;
    submitBtn.textContent = "جارٍ الإرسال...";

    try{
      const payload = { form_id: currentForm?.id || 1 };

      // جمع قيم الحقول بناء على key
      currentFields.forEach(f => {
        const key = f.options?.key || "";
        if(!key) return;
        const el = document.querySelector(`[name="${CSS.escape(key)}"]`);
        payload[key] = el ? el.value : "";
      });

      const res = await fetch("/api/register", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });

      const data = await res.json();

      if(!res.ok || !data.ok){
        showMsg("err", `تعذر الإرسال: <b>${esc(data?.error || "خطأ")}</b>`);
        return;
      }

      showMsg("ok", `
        ✅ ${esc(data.message || "تم التسجيل")}<br>
        رابط التأكيد: <a href="${esc(data.confirmUrl)}" target="_blank">فتح رابط التأكيد</a><br>
        <span class="muted">Token: <code>${esc(data.token)}</code></span>
      `);

      formEl.reset?.();

    }catch(e){
      showMsg("err", `خطأ: ${esc(e.message || e)}`);
    }finally{
      submitBtn.disabled = false;
      submitBtn.textContent = "إرسال";
    }
  }

  submitBtn.addEventListener("click", submitForm);
  loadForm();
</script>
</body>
</html>
