<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>

  <!-- Ø®Ø· Ø¹Ø±Ø¨ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --brand:#5b2ea6;   /* Ù‚Ø±ÙŠØ¨ Ù…Ù† Ø§Ù„Ø¨Ù†ÙØ³Ø¬ÙŠ Ø¨Ø§Ù„Ù…Ø«Ø§Ù„ */
      --brand2:#7a43d1;
      --ok:#16a34a;
      --warn:#f59e0b;
      --shadow: 0 10px 24px rgba(17,24,39,.06);
      --r:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Tajawal", system-ui, -apple-system, Segoe UI, Arial;
      background:var(--bg);
      color:var(--text);
    }
    .container{
      max-width:1100px;
      margin:24px auto;
      padding:0 16px;
    }

    /* Hero */
    .hero{
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      color:#fff;
      border-radius:22px;
      padding:22px 22px;
      box-shadow: var(--shadow);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
    }
    .hero h1{margin:0;font-size:24px;font-weight:800}
    .hero p{margin:6px 0 0;color:rgba(255,255,255,.85);font-size:14px}
    .hero .actions{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .btn{
      border:0;
      padding:10px 14px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      font-size:14px;
    }
    .btn.light{background:rgba(255,255,255,.18); color:#fff}
    .btn.white{background:#fff; color:var(--brand)}
    .btn:active{transform:translateY(1px)}

    /* cards */
    .grid{
      margin-top:16px;
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--r);
      padding:14px;
      box-shadow: 0 6px 16px rgba(17,24,39,.04);
    }
    .stat{
      grid-column: span 3;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
    }
    .stat .meta{display:flex; flex-direction:column; gap:6px;}
    .stat .label{color:var(--muted); font-size:13px; font-weight:600;}
    .stat .value{font-size:26px; font-weight:900;}
    .pill{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      font-weight:800;
      background:#eef2ff;
      color:#3730a3;
      white-space:nowrap;
    }
    .iconbox{
      width:44px;height:44px;border-radius:14px;
      display:grid;place-items:center;
      background:#f3f4f6;
    }

    /* sections */
    .section-title{
      margin:18px 0 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .section-title h2{
      margin:0;
      font-size:16px;
      font-weight:900;
      color:#111827;
    }
    .section-title .sub{
      font-size:13px;
      color:var(--muted);
      font-weight:600;
    }

    /* table */
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:14px;
    }
    thead th{
      text-align:right;
      font-size:13px;
      color:var(--muted);
      font-weight:800;
      background:#fafafa;
      border-bottom:1px solid var(--border);
      padding:12px 10px;
    }
    tbody td{
      padding:12px 10px;
      border-bottom:1px solid var(--border);
      font-weight:600;
      font-size:14px;
      vertical-align:middle;
      background:#fff;
    }
    tbody tr:last-child td{border-bottom:0}
    .status{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      border:1px solid var(--border);
      background:#fff;
    }
    .dot{width:8px;height:8px;border-radius:50%;}
    .s-pending .dot{background:var(--warn)}
    .s-confirmed .dot{background:var(--ok)}
    .s-pending{color:#92400e}
    .s-confirmed{color:#166534}

    /* WhatsApp button */
    .wa{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid #d1fae5;
      background:#ecfdf5;
      color:#065f46;
      font-weight:900;
      text-decoration:none;
      font-size:13px;
      white-space:nowrap;
    }
    .wa:hover{filter:brightness(.98)}
    .wa svg{width:16px;height:16px}

    /* responsive */
    @media (max-width: 980px){
      .stat{grid-column: span 6;}
    }
    @media (max-width: 640px){
      .hero{flex-direction:column; align-items:flex-start}
      .stat{grid-column: span 12;}
      thead{display:none}
      table, tbody, tr, td{display:block; width:100%}
      tbody td{border-bottom:0}
      tbody tr{border-bottom:1px solid var(--border)}
      tbody td[data-label]::before{
        content: attr(data-label) " : ";
        color:var(--muted);
        font-weight:900;
      }
    }
  </style>
</head>

<body>
  <div class="container">

    <div class="hero">
      <div>
        <h1 id="hello">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ğŸ‘‹</h1>
        <p id="updated">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: â€”</p>
      </div>
      <div class="actions">
        <button class="btn light" id="btnRefresh">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <a class="btn white" href="/" style="text-decoration:none;">ÙØªØ­ Ø§Ù„ÙÙˆØ±Ù…</a>
      </div>
    </div>

    <!-- Stats -->
    <div class="grid">
      <div class="card stat">
        <div class="meta">
          <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
          <div class="value" id="total">â€”</div>
        </div>
        <div class="iconbox" title="Ø¥Ø¬Ù…Ø§Ù„ÙŠ">
          <!-- icon -->
          <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 3h18v6H3z"/><path d="M3 15h18v6H3z"/><path d="M3 9h18v6H3z"/>
          </svg>
        </div>
      </div>

      <div class="card stat">
        <div class="meta">
          <div class="label">Ù…Ø¤ÙƒØ¯Ø©</div>
          <div class="value" id="confirmed">â€”</div>
        </div>
        <div class="pill" style="background:#ecfdf5;color:#166534;">ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯</div>
      </div>

      <div class="card stat">
        <div class="meta">
          <div class="label">Ù…Ø¹Ù„Ù‘Ù‚Ø©</div>
          <div class="value" id="pending">â€”</div>
        </div>
        <div class="pill" style="background:#fffbeb;color:#92400e;">ØªØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø©</div>
      </div>

      <div class="card stat">
        <div class="meta">
          <div class="label">Ø§Ù„Ù…Ø¯Ù†</div>
          <div class="value" id="citiesCount">â€”</div>
        </div>
        <div class="iconbox" title="Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©">
          <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 21s7-4.5 7-10a7 7 0 0 0-14 0c0 5.5 7 10 7 10z"/>
            <circle cx="12" cy="11" r="2"/>
          </svg>
        </div>
      </div>
    </div>

    <!-- By City -->
    <div class="section-title">
      <h2>Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</h2>
      <div class="sub" id="cityHint">â€”</div>
    </div>
    <div class="card">
      <table>
        <thead>
          <tr>
            <th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th>
            <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
            <th>Ù…Ø¤ÙƒØ¯Ø©</th>
            <th>Ù…Ø¹Ù„Ù‘Ù‚Ø©</th>
          </tr>
        </thead>
        <tbody id="byCityBody"></tbody>
      </table>
    </div>

    <!-- Latest -->
    <div class="section-title">
      <h2>Ø¢Ø®Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>
      <div class="sub">Ø§Ø¶ØºØ· ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹</div>
    </div>
    <div class="card">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Ø§Ù„Ø§Ø³Ù…</th>
            <th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>ÙˆØ§ØªØ³Ø§Ø¨</th>
          </tr>
        </thead>
        <tbody id="latestBody"></tbody>
      </table>
    </div>

  </div>

<script>
  // âœ… Ø¹Ø¯Ù‘Ù„ÙŠÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø¨Ø­Ø³Ø¨ Ø·Ø±ÙŠÙ‚Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„
  const CLIENT_NAME = "Ø§Ù„Ø¹Ù…ÙŠÙ„";

  function fmtDate(iso){
    try{
      const d = new Date(iso);
      return d.toLocaleString("ar-SA", { dateStyle:"medium", timeStyle:"short" });
    }catch(e){ return iso || "-" }
  }

  function statusBadge(status){
    const isConfirmed = (status || "").toLowerCase() === "confirmed";
    const cls = isConfirmed ? "s-confirmed" : "s-pending";
    const label = isConfirmed ? "Ù…Ø¤ÙƒØ¯" : "Ù…Ø¹Ù„Ù‚";
    return `
      <span class="status ${cls}">
        <span class="dot"></span>
        ${label}
      </span>
    `;
  }

  function waLink(mobile, name, token){
    if(!mobile || !token) return "-";
  
    let m = String(mobile).trim();
  
    // ØªÙˆØ­ÙŠØ¯ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„
    if(m.startsWith("05")) m = "966" + m.slice(1);
    if(m.startsWith("5") && m.length === 9) m = "966" + m;
    m = m.replace(/[^\d]/g, "");
  
    const confirmUrl = `https://talab.hindtech.sa/confirm.html?token=${token}`;
  
    const msg = encodeURIComponent(
  `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${name || ""} 
  ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­.
  
  Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø·:
  ${confirmUrl}`
    );
  
    return `https://wa.me/${m}?text=${msg}`;
  }
  

  async function loadUser() {
    const res = await fetch("/api/me", { credentials: "include" });
    if (!res.ok) return { name: "Ù…Ø³ØªØ®Ø¯Ù…", email: "" };

    const u = await res.json();

    // Ø§Ø³Ù… Ù„Ø·ÙŠÙ Ù…Ù† Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„: Ù‚Ø¨Ù„ @ Ù…Ø¹ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ§Ù„Ø´Ø±Ø·Ø§Øª
    const pretty =
      (u.name || "")
        .replace(/[._-]+/g, " ")
        .trim();

    return { name: pretty || "Ù…Ø³ØªØ®Ø¯Ù…", email: u.email || "" };
  }
  async function loadDashboard(){
    const user = await loadUser();
    // IMPORTANT: Ø¥Ø°Ø§ ØµØ§Ø± ÙÙŠÙ‡ Ù…Ø´ÙƒÙ„Ø© cookiesØŒ Ù†Ø¶ÙŠÙ credentials
    const res = await fetch("/api/stats", { credentials: "include" });
    if(!res.ok){
      document.body.innerHTML = "ØºÙŠØ± Ù…ØµØ±Ø­ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„";
      return;
    }

    const data = await res.json();

    // Header
    document.getElementById("hello").textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒØŒ ${user.name} ğŸ‘‹`;
    document.getElementById("updated").textContent = `Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${new Date().toLocaleString("ar-SA")}`;

    // Cards
    document.getElementById("total").textContent = data?.cards?.total ?? 0;
    document.getElementById("confirmed").textContent = data?.cards?.confirmed ?? 0;
    document.getElementById("pending").textContent = data?.cards?.pending ?? 0;
    document.getElementById("citiesCount").textContent = (data?.byCity?.length ?? 0);
    document.getElementById("cityHint").textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ù†: ${(data?.byCity?.length ?? 0)}`;

    // By City table
    const byCityBody = document.getElementById("byCityBody");
    byCityBody.innerHTML = (data.byCity || []).map(r => `
      <tr>
        <td data-label="Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©">${r.city || "-"}</td>
        <td data-label="Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ">${r.total ?? 0}</td>
        <td data-label="Ù…Ø¤ÙƒØ¯Ø©">${r.confirmed ?? 0}</td>
        <td data-label="Ù…Ø¹Ù„Ù‘Ù‚Ø©">${r.pending ?? 0}</td>
      </tr>
    `).join("");

    // Latest table
    const latestBody = document.getElementById("latestBody");
    latestBody.innerHTML = (data.latest || []).map(r => `
      <tr>
        <td data-label="#">${r.id}</td>
        <td data-label="Ø§Ù„Ø§Ø³Ù…">${r.name || "-"}</td>
        <td data-label="Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©">${r.city || "-"}</td>
        <td data-label="Ø§Ù„Ø­Ø§Ù„Ø©">${statusBadge(r.status)}</td>
        <td data-label="Ø§Ù„ØªØ§Ø±ÙŠØ®">${fmtDate(r.created_at)}</td>
     <td data-label="ÙˆØ§ØªØ³Ø§Ø¨">
  ${(r.mobile && r.token) ? `
    <a class="wa"
       target="_blank"
       rel="noopener"
       href="${waLink(r.mobile, r.name, r.token)}">
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M20.5 3.5A11 11 0 0 0 3.3 18.7L2 22l3.4-1.2A11 11 0 0 0 20.5 3.5ZM12 20a9 9 0 0 1-4.6-1.3l-.3-.2-2 .7.7-2-.2-.3A9 9 0 1 1 12 20Zm5-6.1c-.3-.1-1.7-.8-2-1s-.5-.1-.7.1-.8 1-.9 1.2-.3.2-.6.1a7.4 7.4 0 0 1-2.2-1.4 8.2 8.2 0 0 1-1.5-1.9c-.1-.3 0-.5.1-.6l.4-.5c.1-.2.2-.3.3-.5s0-.3 0-.5-.7-1.7-1-2.3c-.3-.6-.6-.5-.7-.5h-.6c-.2 0-.5.1-.7.3s-1 1-1 2.4 1 2.8 1.1 3 .3.5.5.8a11 11 0 0 0 4.2 3.8c.6.3 1.1.5 1.5.7.6.2 1.1.2 1.5.1.5-.1 1.7-.7 1.9-1.3s.2-1.1.1-1.3-.2-.1-.5-.3Z"/>
      </svg>
      ÙˆØ§ØªØ³Ø§Ø¨
    </a>
  ` : `<span style="color:#9ca3af">ØºÙŠØ± Ù…ØªØ§Ø­</span>`}
</td>


      </tr>
    `).join("");
  }

  document.getElementById("btnRefresh").addEventListener("click", loadDashboard);
  loadDashboard();
</script>
</body>
</html>
