<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --brand:#5b2ea6;
      --brand2:#7a43d1;
      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow: 0 10px 24px rgba(17,24,39,.06);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Tajawal", system-ui, -apple-system, Segoe UI, Arial;
      background:var(--bg);
      color:var(--text);
    }
    .container{
      max-width:1100px;
      margin:22px auto;
      padding:0 16px;
    }

    /* Top header only (user + time) */
    .topbar{
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      color:#fff;
      border-radius:22px;
      padding:18px 18px;
      box-shadow: var(--shadow);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .topbar h1{margin:0;font-size:22px;font-weight:900}
    .topbar .meta{margin-top:6px;color:rgba(255,255,255,.85);font-size:13px;font-weight:600}
    .topbar .right{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .pill{
      background:rgba(255,255,255,.16);
      border:1px solid rgba(255,255,255,.22);
      color:#fff;
      border-radius:999px;
      padding:8px 12px;
      font-weight:900;
      font-size:13px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .btn{
      border:0;
      padding:10px 14px;
      border-radius:12px;
      cursor:pointer;
      font-weight:900;
      font-size:14px;
      font-family:inherit;
    }
    .btn.white{background:#fff;color:var(--brand)}
    .btn.light{background:rgba(255,255,255,.18);color:#fff;border:1px solid rgba(255,255,255,.22)}
    .btn:active{transform:translateY(1px)}

    /* Sections */
    .section-title{
      margin:18px 0 10px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
    }
    .section-title h2{
      margin:0;
      font-size:16px;
      font-weight:900;
      color:#111827;
    }
    .section-title .sub{
      font-size:13px;
      color:var(--muted);
      font-weight:700;
    }

    /* Cards grid (My Forms) */
    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
    }
    .form-card{
      grid-column: span 4;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 6px 16px rgba(17,24,39,.05);
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:120px;
      position:relative;
      overflow:hidden;
    }
    .form-card.active{border-color:#c4b5fd; box-shadow: 0 10px 22px rgba(91,46,166,.10);}
    .form-title{font-weight:900;font-size:15px}
    .form-slug{color:var(--muted);font-size:12px;direction:ltr;text-align:left}
    .form-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:auto}
    .form-actions button{
      padding:8px 10px;border-radius:12px;border:1px solid var(--border);
      background:#fafafa;cursor:pointer;font-weight:900;font-family:inherit;
    }
    .form-actions button.primary{
      background:#fff;color:var(--brand);border-color:#e9d5ff
    }
    .form-actions button:hover{filter:brightness(.98)}

    /* Create card (always first) */
    .create-card{
      border-style:dashed;
      border-color:#d6ccff;
      background: linear-gradient(180deg, rgba(124,58,237,.06), rgba(124,58,237,.02));
      cursor:pointer;
    }
    .create-icon{
      width:48px;height:48px;border-radius:16px;
      display:grid;place-items:center;
      background:#fff;
      border:1px solid #efeaff;
      color:var(--brand);
      font-size:26px;
      font-weight:900;
    }
    .create-hint{color:var(--muted);font-size:13px;font-weight:700;line-height:1.6}

    /* Stats area (hidden until select form) */
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 6px 16px rgba(17,24,39,.04);
    }
    .stats-wrap{display:none;margin-top:18px}
    .stats-wrap.show{display:block}
    .stats-head{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap
    }
    .stats-head .left{
      display:flex;align-items:center;gap:10px;flex-wrap:wrap
    }
    .tag{
      font-size:12px;
      padding:7px 10px;border-radius:999px;
      font-weight:900;
      background:#eef2ff;color:#3730a3;border:1px solid #e0e7ff;
      direction:ltr;
    }

    /* Stat chips */
    .chips{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
    }
    .chip{
      grid-column: span 3;
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      background:#fff;
      display:flex;justify-content:space-between;align-items:center;gap:10px;
    }
    .chip .k{color:var(--muted);font-size:13px;font-weight:800}
    .chip .v{font-size:22px;font-weight:900}
    .chip .dot{width:10px;height:10px;border-radius:50%}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}
    .dot.neutral{background:#94a3b8}

    /* City cards */
    .city-card{
      grid-column: span 3;
      background:#fff;
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 6px 16px rgba(17,24,39,.05);
      text-align:center;
    }
    .city-name{font-weight:900;margin-bottom:10px}
    .circle{
      width:90px;height:90px;border-radius:50%;
      margin:0 auto 10px;
      display:grid;place-items:center;
      font-weight:900;font-size:14px;color:#111827;
      background: conic-gradient(var(--ok) calc(var(--p) * 1%), #e5e7eb 0);
    }
    .city-meta{
      font-size:12px;color:var(--muted);
      display:flex;justify-content:space-between;margin-top:6px;
      direction:ltr;
    }

    /* Table */
    table{width:100%;border-collapse:separate;border-spacing:0;border-radius:14px;overflow:hidden}
    thead th{
      text-align:right;font-size:13px;color:var(--muted);font-weight:900;
      background:#fafafa;border-bottom:1px solid var(--border);
      padding:12px 10px;
    }
    tbody td{
      padding:12px 10px;border-bottom:1px solid var(--border);
      font-weight:600;font-size:14px;vertical-align:middle;background:#fff;
    }
    tbody tr:last-child td{border-bottom:0}

    .status{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      font-weight:900;font-size:12px;border:1px solid var(--border);background:#fff;
    }
    .s-pending{color:#92400e}
    .s-confirmed{color:#166534}
    .s-canceled{color:#991b1b}
    .s-pending .sdot{background:var(--warn)}
    .s-confirmed .sdot{background:var(--ok)}
    .s-canceled .sdot{background:var(--bad)}
    .sdot{width:8px;height:8px;border-radius:50%}

    /* WhatsApp button */
    .wa{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:12px;
      border:1px solid #d1fae5;background:#ecfdf5;color:#065f46;
      font-weight:900;text-decoration:none;font-size:13px;white-space:nowrap;
    }
    .wa:hover{filter:brightness(.98)}
    .wa svg{width:16px;height:16px}

    /* Empty state */
    .empty{
      padding:18px;border-radius:18px;border:1px dashed #d1d5db;
      background:#fff;color:var(--muted);font-weight:800;
    }

    /* Modal */
    #modalBack{
      position:fixed;inset:0;background:rgba(0,0,0,.35);
      display:none;place-items:center;padding:18px;z-index:9999;
    }
    .modal{
      width:min(520px,100%);background:#fff;border-radius:18px;
      padding:16px;border:1px solid #e5e7eb;
    }
    .modal h3{margin:0 0 10px;font-weight:900}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-weight:900}
    .field input{
      width:100%;padding:12px;border-radius:12px;border:1px solid #e5e7eb;
      font-family:inherit;
      direction:rtl;
    }
    .help{color:#6b7280;font-size:12px;font-weight:700}
    .msg{
      display:none;padding:10px;border-radius:12px;border:1px solid #e5e7eb;
      background:#fafafa;font-weight:900;
    }

    @media (max-width: 980px){
      .form-card{grid-column:span 6}
      .chip{grid-column:span 6}
      .city-card{grid-column:span 6}
    }
    @media (max-width: 640px){
      .topbar{flex-direction:column;align-items:flex-start}
      .form-card{grid-column:span 12}
      .chip{grid-column:span 12}
      .city-card{grid-column:span 12}
      thead{display:none}
      table, tbody, tr, td{display:block; width:100%}
      tbody td{border-bottom:0}
      tbody tr{border-bottom:1px solid var(--border)}
      tbody td[data-label]::before{
        content: attr(data-label) " : ";
        color:var(--muted);
        font-weight:900;
      }
    }
  </style>
</head>

<body>
  <div class="container">

    <!-- TOP (user + time only) -->
    <div class="topbar">
      <div>
        <h1 id="hello">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ğŸ‘‹</h1>
        <div class="meta" id="updated">Last update: â€”</div>
      </div>

      <div class="right">
        <div class="pill" title="Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø­Ø§Ù„ÙŠ">
          <span>Ø§Ù„Ù†Ù…ÙˆØ°Ø¬:</span>
          <strong id="currentFormName">â€”</strong>
        </div>

        <button class="btn white" id="btnOpenForm" type="button">ÙØªØ­ Ø§Ù„ÙÙˆØ±Ù…</button>
        <button class="btn light" id="btnNewForm" type="button">+ Ø¥Ù†Ø´Ø§Ø¡ Ù†Ù…ÙˆØ°Ø¬</button>
      </div>
    </div>

    <!-- MY FORMS -->
    <div class="section-title">
      <h2>Ù†Ù…Ø§Ø°Ø¬ÙŠ</h2>
      <div class="sub">Ø§Ø®ØªØ§Ø±ÙŠ Ù†Ù…ÙˆØ°Ø¬ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø£Ùˆ Ø§ÙØªØ­ÙŠÙ‡</div>
    </div>

    <div class="grid" id="formsGrid">
      <div class="empty">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬â€¦</div>
    </div>

    <!-- STATS (only show after selecting a form) -->
    <div class="stats-wrap" id="statsWrap">
      <div class="section-title">
        <h2>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</h2>
        <div class="sub" id="statsHint">â€”</div>
      </div>

      <div class="card">
        <div class="stats-head">
          <div class="left">
            <strong id="statsFormTitle" style="font-size:15px">â€”</strong>
            <span class="tag" id="statsFormSlug">â€”</span>
          </div>
        </div>

        <div class="chips">
          <div class="chip">
            <div>
              <div class="k">Total</div>
              <div class="v" id="total">â€”</div>
            </div>
            <span class="dot neutral"></span>
          </div>

          <div class="chip">
            <div>
              <div class="k">Confirmed</div>
              <div class="v" id="confirmed">â€”</div>
            </div>
            <span class="dot ok"></span>
          </div>

          <div class="chip">
            <div>
              <div class="k">Pending</div>
              <div class="v" id="pending">â€”</div>
            </div>
            <span class="dot warn"></span>
          </div>

          <div class="chip">
            <div>
              <div class="k">Canceled</div>
              <div class="v" id="canceled">â€”</div>
            </div>
            <span class="dot bad"></span>
          </div>
        </div>
      </div>

      <div class="section-title">
        <h2>Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</h2>
        <div class="sub" id="cityHint">â€”</div>
      </div>
      <div class="grid" id="citiesGrid"></div>

      <div class="section-title">
        <h2>Ø¢Ø®Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>
        <div class="sub">Ø§Ø¶ØºØ· ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹</div>
      </div>
      <div class="card">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Ø§Ù„Ø§Ø³Ù…</th>
              <th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>ÙˆØ§ØªØ³Ø§Ø¨</th>
            </tr>
          </thead>
          <tbody id="latestBody"></tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- MODAL -->
  <div id="modalBack">
    <div class="modal">
      <h3>Ø¥Ù†Ø´Ø§Ø¡ Ù†Ù…ÙˆØ°Ø¬ Ø¬Ø¯ÙŠØ¯</h3>

      <div style="display:flex;flex-direction:column;gap:12px">
        <div class="field">
          <label>Ø§Ø³Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</label>
          <input id="newFormName" placeholder="Ù…Ø«Ø§Ù„: Ø·Ù„Ø¨Ø§Øª Ø±Ù…Ø¶Ø§Ù†" />
        </div>

        <div class="field">
          <label>Slug (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="newFormSlug" placeholder="ramadan-requests" style="direction:ltr;text-align:left" />
          <div class="help">Ù„Ùˆ ØªØ±ÙƒØªÙŠÙ‡ ÙØ§Ø¶ÙŠ Ø¨Ù†ÙˆÙ„Ø¯Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</div>
        </div>

        <div id="newFormMsg" class="msg"></div>

        <div style="display:flex;gap:10px;justify-content:flex-start;margin-top:2px">
          <button class="btn white" id="btnCreateForm" type="button">Ø¥Ù†Ø´Ø§Ø¡</button>
          <button class="btn light" id="btnCloseModal" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>
    </div>
  </div>

<script>
  // ---------- helpers ----------
  function num(n){ return Number(n || 0).toLocaleString("en-US"); }

  function fmtDate(iso){
    try{
      const d = new Date(iso);
      return d.toLocaleString("en-US", {
        year:"numeric", month:"short", day:"2-digit",
        hour:"2-digit", minute:"2-digit", hour12:false
      });
    }catch(e){ return iso || "-" }
  }

  function statusBadge(status){
    const s = String(status || "").toLowerCase();
    if (s === "confirmed" || s === "received") {
      return '<span class="status s-confirmed"><span class="sdot"></span>Confirmed</span>';
    }
    if (s === "canceled" || s === "cancelled") {
      return '<span class="status s-canceled"><span class="sdot"></span>Canceled</span>';
    }
    return '<span class="status s-pending"><span class="sdot"></span>Pending</span>';
  }

  function waLink(mobile, name, token){
    if(!mobile || !token) return "-";
    let m = String(mobile).trim();
    if(m.startsWith("05")) m = "966" + m.slice(1);
    if(m.startsWith("5") && m.length === 9) m = "966" + m;
    m = m.replace(/[^\d]/g, "");

    const confirmUrl = `https://talab.hindtech.sa/confirm.html?token=${token}`;
    const msg = encodeURIComponent(
`Hello ${name || ""}

Your request has been registered successfully.

To confirm, open:
${confirmUrl}`
    );
    return `https://wa.me/${m}?text=${msg}`;
  }

  // ---------- state ----------
  let FORMS_CACHE = [];
  let CURRENT_FORM_ID = null;

  function getCurrentForm(){
    return FORMS_CACHE.find(f => Number(f.id) === Number(CURRENT_FORM_ID)) || null;
  }

  // ---------- auth/user ----------
  async function loadUser(){
    try{
      const res = await fetch("/api/me", { credentials:"include" });
      if(!res.ok) throw new Error("unauthorized");
      const u = await res.json();

      const name =
        (u.name && u.name !== "Ù…Ø³ØªØ®Ø¯Ù…")
          ? u.name
          : (u.email ? u.email.split("@")[0] : "Ù…Ø³ØªØ®Ø¯Ù…");

      return { name, email: u.email || "" };
    }catch{
      return { name:"Ù…Ø³ØªØ®Ø¯Ù…", email:"" };
    }
  }

  // ---------- forms ----------
  async function loadMyForms(){
    const res = await fetch("/api/forms", { credentials:"include" });
    if(!res.ok) throw new Error("forms load failed");
    const data = await res.json();
    if(!data.ok) throw new Error(data.error || "forms error");
    return data.forms || [];
  }

  function openModal(){
    document.getElementById("modalBack").style.display = "grid";
    document.getElementById("newFormMsg").style.display = "none";
    document.getElementById("newFormName").value = "";
    document.getElementById("newFormSlug").value = "";
  }
  function closeModal(){
    document.getElementById("modalBack").style.display = "none";
  }

  function renderFormsGrid(){
    const grid = document.getElementById("formsGrid");

    // create card always first
    const createCard = `
      <div class="form-card create-card" id="createCard">
        <div class="create-icon">+</div>
        <div class="form-title">Ø¥Ù†Ø´Ø§Ø¡ Ù†Ù…ÙˆØ°Ø¬</div>
        <div class="create-hint">Ø§Ø¨Ø¯Ø¦ÙŠ Ù†Ù…ÙˆØ°Ø¬ Ø¬Ø¯ÙŠØ¯ØŒ ÙˆØ¨Ø¹Ø¯Ù‡Ø§ ØªÙ‚Ø¯Ø±ÙŠ ØªÙØªØ­ÙŠÙ‡ ÙˆØªØªØ§Ø¨Ø¹ÙŠ Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙ‡ Ù…Ù† Ù‡Ù†Ø§.</div>
      </div>
    `;

    if(!FORMS_CACHE.length){
      grid.innerHTML = createCard + `
        <div class="form-card" style="grid-column:span 8">
          <div class="form-title">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ù…Ø§Ø°Ø¬ Ø¨Ø¹Ø¯</div>
          <div class="create-hint">Ø§Ø¶ØºØ·ÙŠ â€œØ¥Ù†Ø´Ø§Ø¡ Ù†Ù…ÙˆØ°Ø¬â€ Ù„Ù„Ø¨Ø¯Ø¡.</div>
        </div>
      `;
      document.getElementById("currentFormName").textContent = "â€”";
      document.getElementById("statsWrap").classList.remove("show");
      document.getElementById("createCard").addEventListener("click", openModal);
      return;
    }

    const cards = FORMS_CACHE.map(f => {
      const active = Number(f.id) === Number(CURRENT_FORM_ID);
      const formLink = `/?form_id=${encodeURIComponent(f.id)}`;
      return `
        <div class="form-card ${active ? "active" : ""}">
          <div class="form-title">${f.name}</div>
          <div class="form-slug">${f.slug}</div>

          <div class="form-actions">
            <button class="primary" data-open="${f.id}">ÙØªØ­</button>
            <button data-stats="${f.id}">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
            <button data-copy="${f.id}">Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
          </div>
        </div>
      `;
    }).join("");

    grid.innerHTML = createCard + cards;

    // events
    document.getElementById("createCard").addEventListener("click", openModal);

    grid.querySelectorAll("[data-open]").forEach(btn=>{
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-open");
        window.open(`/?form_id=${encodeURIComponent(id)}`, "_blank");
      });
    });

    grid.querySelectorAll("[data-stats]").forEach(btn=>{
      btn.addEventListener("click", async () => {
        const id = Number(btn.getAttribute("data-stats"));
        CURRENT_FORM_ID = id;
        localStorage.setItem("current_form_id", String(id));
        renderFormsGrid();
        await loadDashboardStats();
      });
    });

    grid.querySelectorAll("[data-copy]").forEach(btn=>{
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-copy");
        const link = `${location.origin}/?form_id=${encodeURIComponent(id)}`;
        await navigator.clipboard.writeText(link);
        const old = btn.textContent;
        btn.textContent = "ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…";
        setTimeout(()=> btn.textContent = old, 900);
      });
    });
  }

  function pickInitialFormId(){
    const saved = localStorage.getItem("current_form_id");
    const first = FORMS_CACHE[0]?.id;
    CURRENT_FORM_ID = Number(saved || first || 0) || null;
    // Ù„Ùˆ saved ÙŠØ´ÙŠØ± Ù„Ø´ÙŠ Ù…Ø­Ø°ÙˆÙ
    if(CURRENT_FORM_ID && !FORMS_CACHE.some(f => Number(f.id) === Number(CURRENT_FORM_ID))){
      CURRENT_FORM_ID = Number(first || 0) || null;
      localStorage.setItem("current_form_id", String(CURRENT_FORM_ID || ""));
    }
  }

  function openCurrentForm(){
    const f = getCurrentForm();
    if(!f) return alert("Ø§Ø®ØªØ§Ø±ÙŠ Ù†Ù…ÙˆØ°Ø¬ Ø£ÙˆÙ„Ø§Ù‹");
    window.open(`/?form_id=${encodeURIComponent(f.id)}`, "_blank");
  }

  // ---------- stats ----------
  async function loadDashboardStats(){
    const statsWrap = document.getElementById("statsWrap");
    const f = getCurrentForm();

    if(!f || !CURRENT_FORM_ID){
      statsWrap.classList.remove("show");
      document.getElementById("currentFormName").textContent = "â€”";
      return;
    }

    document.getElementById("currentFormName").textContent = f.name;

    const user = await loadUser();
    document.getElementById("hello").textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒØŒ ${user.name} ğŸ‘‹`;
    document.getElementById("updated").textContent = `Last update: ${new Date().toLocaleString("en-US")}`;

    const res = await fetch(`/api/stats?form_id=${encodeURIComponent(CURRENT_FORM_ID)}`, { credentials:"include" });
    if(!res.ok){
      statsWrap.classList.remove("show");
      alert("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª. ØªØ£ÙƒØ¯ÙŠ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Access Ø£Ùˆ Ù…Ù† API.");
      return;
    }
    const data = await res.json();

    // show stats now
    statsWrap.classList.add("show");
    document.getElementById("statsFormTitle").textContent = f.name;
    document.getElementById("statsFormSlug").textContent = f.slug;
    document.getElementById("statsHint").textContent = `Form ID: ${f.id}`;

    // cards
    document.getElementById("total").textContent = num(data?.cards?.total ?? 0);
    document.getElementById("confirmed").textContent = num(data?.cards?.confirmed ?? 0);
    document.getElementById("pending").textContent = num(data?.cards?.pending ?? 0);
    document.getElementById("canceled").textContent = num(data?.cards?.canceled ?? 0);

    // cities
    const byCity = data.byCity || [];
    document.getElementById("cityHint").textContent = `Cities: ${num(byCity.length)}`;

    const citiesGrid = document.getElementById("citiesGrid");
    citiesGrid.innerHTML = byCity.map(c => {
      const total = Number(c.total || 0);
      const confirmed = Number(c.confirmed || 0);
      const percent = total ? Math.round((confirmed / total) * 100) : 0;
      return `
        <div class="city-card">
          <div class="city-name">${c.city || "-"}</div>
          <div class="circle" style="--p:${percent}">${percent}%</div>
          <div class="city-meta">
            <span>Confirmed: ${num(confirmed)}</span>
            <span>Total: ${num(total)}</span>
          </div>
        </div>
      `;
    }).join("");

    // latest table
    const latestBody = document.getElementById("latestBody");
    const latest = data.latest || [];
    latestBody.innerHTML = latest.map(r => `
      <tr>
        <td data-label="#">${num(r.id)}</td>
        <td data-label="Ø§Ù„Ø§Ø³Ù…">${r.name || "-"}</td>
        <td data-label="Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©">${r.city || "-"}</td>
        <td data-label="Ø§Ù„Ø­Ø§Ù„Ø©">${statusBadge(r.status)}</td>
        <td data-label="Ø§Ù„ØªØ§Ø±ÙŠØ®">${fmtDate(r.created_at)}</td>
        <td data-label="ÙˆØ§ØªØ³Ø§Ø¨">
          ${(r.mobile && r.token) ? `
            <a class="wa" target="_blank" rel="noopener" href="${waLink(r.mobile, r.name, r.token)}">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M20.5 3.5A11 11 0 0 0 3.3 18.7L2 22l3.4-1.2A11 11 0 0 0 20.5 3.5ZM12 20a9 9 0 0 1-4.6-1.3l-.3-.2-2 .7.7-2-.2-.3A9 9 0 1 1 12 20Zm5-6.1c-.3-.1-1.7-.8-2-1s-.5-.1-.7.1-.8 1-.9 1.2-.3.2-.6.1a7.4 7.4 0 0 1-2.2-1.4 8.2 8.2 0 0 1-1.5-1.9c-.1-.3 0-.5.1-.6l.4-.5c.1-.2.2-.3.3-.5s0-.3 0-.5-.7-1.7-1-2.3c-.3-.6-.6-.5-.7-.5h-.6c-.2 0-.5.1-.7.3s-1 1-1 2.4 1 2.8 1.1 3 .3.5.5.8a11 11 0 0 0 4.2 3.8c.6.3 1.1.5 1.5.7.6.2 1.1.2 1.5.1.5-.1 1.7-.7 1.9-1.3s.2-1.1.1-1.3-.2-.1-.5-.3Z"/>
              </svg>
              WhatsApp
            </a>
          ` : `<span style="color:#9ca3af;font-weight:800">N/A</span>`}
        </td>
      </tr>
    `).join("");
  }

  // ---------- create form ----------
  async function createForm(){
    const msg = document.getElementById("newFormMsg");
    msg.style.display = "block";
    msg.style.background = "#fafafa";
    msg.style.borderColor = "#e5e7eb";
    msg.textContent = "Ø¬Ø§Ø±Ù Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬...";

    const payload = {
      name: document.getElementById("newFormName").value.trim(),
      slug: document.getElementById("newFormSlug").value.trim()
    };

    const res = await fetch("/api/forms-create", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload),
      credentials:"include"
    });

    const data = await res.json().catch(()=> ({}));

    if(!res.ok || !data.ok){
      let m = data.error || "ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬";
      if(m === "NAME_REQUIRED") m = "Ø§ÙƒØªØ¨ÙŠ Ø§Ø³Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬.";
      if(m === "SLUG_EXISTS") m = "Ø§Ù„Ù€ slug Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹ØŒ ØºÙŠØ±ÙŠÙ‡.";
      msg.style.background = "#fef2f2";
      msg.style.borderColor = "#fecaca";
      msg.textContent = m;
      return;
    }

    msg.style.background = "#ecfdf5";
    msg.style.borderColor = "#bbf7d0";
    msg.textContent = `âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬: ${data.form.name}`;

    // Reload forms, select new one, open it immediately
    try{
      FORMS_CACHE = await loadMyForms();
      pickInitialFormId();

      // prefer the newly created
      if(data.form?.id){
        CURRENT_FORM_ID = Number(data.form.id);
        localStorage.setItem("current_form_id", String(CURRENT_FORM_ID));
      }

      renderFormsGrid();
      await loadDashboardStats();

      // Ø§ÙØªØ­ÙŠ Ø§Ù„ÙÙˆØ±Ù… Ù…Ø¨Ø§Ø´Ø±Ø© (New Tab)
      window.open(`/?form_id=${encodeURIComponent(CURRENT_FORM_ID)}`, "_blank");
    }catch(e){
      console.log(e);
    }

    setTimeout(closeModal, 450);
  }

  // ---------- boot ----------
  (async function init(){
    // wire modal
    document.getElementById("btnNewForm").addEventListener("click", openModal);
    document.getElementById("btnCloseModal").addEventListener("click", closeModal);
    document.getElementById("modalBack").addEventListener("click", (e)=>{ if(e.target.id === "modalBack") closeModal(); });
    document.getElementById("btnCreateForm").addEventListener("click", createForm);

    // open current form button
    document.getElementById("btnOpenForm").addEventListener("click", openCurrentForm);

    // user header
    const user = await loadUser();
    document.getElementById("hello").textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒØŒ ${user.name} ğŸ‘‹`;
    document.getElementById("updated").textContent = `Last update: ${new Date().toLocaleString("en-US")}`;

    // load forms
    try{
      FORMS_CACHE = await loadMyForms();
      pickInitialFormId();
      renderFormsGrid();

      // Ù„Ø§ Ù†Ø¸Ù‡Ø± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¥Ù„Ø§ Ø¥Ø°Ø§ ÙÙŠÙ‡ ÙÙˆØ±Ù… Ù…Ø­Ø¯Ø¯
      if(CURRENT_FORM_ID){
        await loadDashboardStats();
      }
    }catch(e){
      console.log(e);
      const grid = document.getElementById("formsGrid");
      grid.innerHTML = `
        <div class="form-card create-card" id="createCard">
          <div class="create-icon">+</div>
          <div class="form-title">Ø¥Ù†Ø´Ø§Ø¡ Ù†Ù…ÙˆØ°Ø¬</div>
          <div class="create-hint">Ø§Ø¨Ø¯Ø¦ÙŠ Ù†Ù…ÙˆØ°Ø¬ Ø¬Ø¯ÙŠØ¯.</div>
        </div>
        <div class="form-card" style="grid-column:span 8">
          <div class="form-title">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬</div>
          <div class="create-hint">ØªØ£ÙƒØ¯ÙŠ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Cloudflare Access Ù„Ù…Ø³Ø§Ø± /api/forms</div>
        </div>
      `;
      document.getElementById("createCard").addEventListener("click", openModal);
    }
  })();
</script>

</body>
</html>
