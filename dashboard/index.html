<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --brand:#5b2ea6;
      --brand2:#7a43d1;
      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow: 0 10px 24px rgba(17,24,39,.06);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Tajawal", system-ui, -apple-system, Segoe UI, Arial;
      background:var(--bg);
      color:var(--text);
    }
    .container{
      max-width:1100px;
      margin:22px auto;
      padding:0 16px;
    }

    /* TOP BAR */
    .topbar{
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      color:#fff;
      border-radius:22px;
      padding:18px 18px;
      box-shadow: var(--shadow);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .topbar h1{margin:0;font-size:22px;font-weight:900}
    .topbar .meta{margin-top:6px;color:rgba(255,255,255,.85);font-size:13px;font-weight:600}
    .pill{
      background:rgba(255,255,255,.16);
      border:1px solid rgba(255,255,255,.22);
      color:#fff;
      border-radius:999px;
      padding:8px 12px;
      font-weight:900;
      font-size:13px;
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }

    /* Section title */
    .section-title{
      margin:18px 0 10px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
    }
    .section-title h2{
      margin:0;
      font-size:16px;
      font-weight:900;
      color:#111827;
    }
    .section-title .sub{
      font-size:13px;
      color:var(--muted);
      font-weight:700;
    }

    /* Forms grid */
    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
    }
    .form-card{
      grid-column: span 4;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 6px 16px rgba(17,24,39,.05);
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:140px;
      position:relative;
      overflow:hidden;
      cursor:pointer;
    }
    .form-card:hover{filter:brightness(.995)}
    .form-card.active{border-color:#c4b5fd; box-shadow: 0 10px 22px rgba(91,46,166,.10);}
    .form-title{font-weight:900;font-size:15px}
    .form-slug{color:var(--muted);font-size:12px;direction:ltr;text-align:left}

    /* Create */
    .create-card{
      border-style:dashed;
      border-color:#d6ccff;
      background: linear-gradient(180deg, rgba(124,58,237,.06), rgba(124,58,237,.02));
      cursor:pointer;
      align-items:flex-start;
    }
    .create-icon{
      width:50px;height:50px;border-radius:16px;
      display:grid;place-items:center;
      background:#fff;
      border:1px solid #efeaff;
      color:var(--brand);
      font-size:28px;
      font-weight:900;
    }
    .create-hint{color:var(--muted);font-size:13px;font-weight:700;line-height:1.7}

    /* Card actions */
    .actions{
      display:flex;gap:8px;flex-wrap:wrap;margin-top:auto;
      cursor:default;
    }
    .btn{
      border:1px solid var(--border);
      background:#fafafa;
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-weight:900;
      font-family:inherit;
      font-size:13px;
    }
    .btn.primary{
      background:#fff;color:var(--brand);border-color:#e9d5ff;
    }
    .btn.danger{
      background:#fff;color:#b91c1c;border-color:#fee2e2;
    }
    .btn:active{transform:translateY(1px)}
    .btn svg{width:16px;height:16px;vertical-align:-3px;margin-left:6px}

    /* Panel */
    .panel{
      margin-top:16px;
      display:none;
    }
    .panel.show{display:block}
    .panel-card{
      background:#fff;
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow: 0 6px 16px rgba(17,24,39,.04);
      overflow:hidden;
    }
    .panel-head{
      padding:14px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      border-bottom:1px solid var(--border);
      flex-wrap:wrap;
    }
    .panel-head .title{
      font-weight:900;
      font-size:15px;
      margin:0;
    }
    .panel-head .meta{
      color:var(--muted);
      font-weight:800;
      font-size:12px;
      direction:ltr;
      text-align:left;
      margin-top:6px;
    }
    .panel-head .right{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    /* Tabs */
    .tabs{
      display:flex;
      gap:8px;
      padding:10px 14px;
      border-bottom:1px solid var(--border);
      background:#fafafa;
      flex-wrap:wrap;
    }
    .tab{
      border:1px solid var(--border);
      background:#fff;
      padding:8px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:900;
      font-family:inherit;
      font-size:13px;
    }
    .tab.active{
      border-color:#c4b5fd;
      color:var(--brand);
      background:#fff;
    }

    .tab-body{padding:14px;}
    .muted{color:var(--muted);font-weight:800}

    /* Stats */
    .chips{
      margin-top:10px;
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
    }
    .chip{
      grid-column: span 3;
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      background:#fff;
      display:flex;justify-content:space-between;align-items:center;gap:10px;
    }
    .chip .k{color:var(--muted);font-size:13px;font-weight:800}
    .chip .v{font-size:22px;font-weight:900}
    .chip .dot{width:10px;height:10px;border-radius:50%}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}
    .dot.neutral{background:#94a3b8}

    .city-grid{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
    }
    .city-card{
      grid-column: span 3;
      background:#fff;
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 6px 16px rgba(17,24,39,.05);
      text-align:center;
    }
    .city-name{font-weight:900;margin-bottom:10px}
    .circle{
      width:90px;height:90px;border-radius:50%;
      margin:0 auto 10px;
      display:grid;place-items:center;
      font-weight:900;font-size:14px;color:#111827;
      background: conic-gradient(var(--ok) calc(var(--p) * 1%), #e5e7eb 0);
    }
    .city-meta{
      font-size:12px;color:var(--muted);
      display:flex;justify-content:space-between;margin-top:6px;
      direction:ltr;
    }

    table{width:100%;border-collapse:separate;border-spacing:0;border-radius:14px;overflow:hidden}
    thead th{
      text-align:right;font-size:13px;color:var(--muted);font-weight:900;
      background:#fafafa;border-bottom:1px solid var(--border);
      padding:12px 10px;
    }
    tbody td{
      padding:12px 10px;border-bottom:1px solid var(--border);
      font-weight:600;font-size:14px;vertical-align:middle;background:#fff;
    }
    tbody tr:last-child td{border-bottom:0}
    .status{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      font-weight:900;font-size:12px;border:1px solid var(--border);background:#fff;
      direction:ltr;
    }
    .s-pending{color:#92400e}
    .s-confirmed{color:#166534}
    .s-canceled{color:#991b1b}
    .s-pending .sdot{background:var(--warn)}
    .s-confirmed .sdot{background:var(--ok)}
    .s-canceled .sdot{background:var(--bad)}
    .sdot{width:8px;height:8px;border-radius:50%}

    /* Modal */
    #modalBack{
      position:fixed;inset:0;background:rgba(0,0,0,.35);
      display:none;place-items:center;padding:18px;z-index:9999;
    }
    .modal{
      width:min(520px,100%);background:#fff;border-radius:18px;
      padding:16px;border:1px solid #e5e7eb;
    }
    .modal h3{margin:0 0 10px;font-weight:900}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-weight:900}
    .field input{
      width:100%;padding:12px;border-radius:12px;border:1px solid #e5e7eb;
      font-family:inherit;
    }
    .help{color:#6b7280;font-size:12px;font-weight:700}
    .msg{
      display:none;padding:10px;border-radius:12px;border:1px solid #e5e7eb;
      background:#fafafa;font-weight:900;
    }

    @media (max-width: 980px){
      .form-card{grid-column:span 6}
      .chip{grid-column:span 6}
      .city-card{grid-column:span 6}
    }
    @media (max-width: 640px){
      .topbar{flex-direction:column;align-items:flex-start}
      .form-card{grid-column:span 12}
      .chip{grid-column:span 12}
      .city-card{grid-column:span 12}
      thead{display:none}
      table, tbody, tr, td{display:block; width:100%}
      tbody td{border-bottom:0}
      tbody tr{border-bottom:1px solid var(--border)}
      tbody td[data-label]::before{
        content: attr(data-label) " : ";
        color:var(--muted);
        font-weight:900;
      }
    }
  </style>
</head>

<body>
  <div class="container">

    <!-- TOP -->
    <div class="topbar">
      <div>
        <h1 id="hello">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ğŸ‘‹</h1>
        <div class="meta" id="updated">Last update: â€”</div>
      </div>
      <div class="pill" title="Ø­Ø³Ø§Ø¨Ùƒ">
        <span id="userEmail">â€”</span>
      </div>
    </div>

    <!-- FORMS -->
    <div class="section-title">
      <h2>Ù†Ù…Ø§Ø°Ø¬ÙŠ</h2>
    </div>

    <div class="grid" id="formsGrid">
      <div class="muted">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬â€¦</div>
    </div>

    <!-- PANEL -->
    <div class="panel" id="panel">
      <div class="panel-card">
        <div class="panel-head">
          <div>
            <div class="title" id="panelTitle">â€”</div>
            <div class="meta" id="panelMeta">â€”</div>
          </div>

          <div class="right">
            <button class="btn primary" id="btnOpenPublic" type="button">ÙØªØ­ Ø§Ù„ÙÙˆØ±Ù…</button>
            <button class="btn" id="btnCopyPublic" type="button">Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
            <button class="btn danger" id="btnDeleteForm" type="button">Ø­Ø°Ù</button>
          </div>
        </div>

        <div class="tabs">
          <button class="tab active" data-tab="edit" type="button">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</button>
          <button class="tab" data-tab="stats" type="button">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
        </div>

        <div class="tab-body" id="tabEdit">
          <div class="muted">
            âœ… Ù‡Ù†Ø§ Ø¨Ù†Ø¶ÙŠÙ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ù† Ø¬Ø¯ÙˆÙ„ <b>form_fields</b>.
            <br><br>
            Ø­Ø§Ù„ÙŠØ§Ù‹: Ø§ÙØªØ­ÙŠ ØªØ¨ÙˆÙŠØ¨ â€œØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øªâ€ Ù„Ø¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù‡Ø°Ø§ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬.
          </div>
        </div>

        <div class="tab-body" id="tabStats" style="display:none">
          <div class="muted" id="statsLoading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øªâ€¦</div>

          <div id="statsContent" style="display:none">
            <div class="chips">
              <div class="chip">
                <div><div class="k">Total</div><div class="v" id="sTotal">â€”</div></div>
                <span class="dot neutral"></span>
              </div>
              <div class="chip">
                <div><div class="k">Confirmed</div><div class="v" id="sConfirmed">â€”</div></div>
                <span class="dot ok"></span>
              </div>
              <div class="chip">
                <div><div class="k">Pending</div><div class="v" id="sPending">â€”</div></div>
                <span class="dot warn"></span>
              </div>
              <div class="chip">
                <div><div class="k">Canceled</div><div class="v" id="sCanceled">â€”</div></div>
                <span class="dot bad"></span>
              </div>
            </div>

            <div class="section-title" style="margin-top:14px">
              <h2>Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</h2>
              <div class="sub" id="cityHint">â€”</div>
            </div>
            <div class="city-grid" id="citiesGrid"></div>

            <div class="section-title" style="margin-top:14px">
              <h2>Ø¢Ø®Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>
              <div class="sub">Gregorian date + English numbers</div>
            </div>

            <div class="panel-card" style="margin:0 14px 14px;border-radius:14px">
              <table>
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Ø§Ù„Ø§Ø³Ù…</th>
                    <th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th>
                    <th>Status</th>
                    <th>Date</th>
                  </tr>
                </thead>
                <tbody id="latestBody"></tbody>
              </table>
            </div>

          </div>
        </div>

      </div>
    </div>

  </div>

  <!-- MODAL -->
  <div id="modalBack">
    <div class="modal">
      <h3>Ø¥Ù†Ø´Ø§Ø¡ Ù†Ù…ÙˆØ°Ø¬ Ø¬Ø¯ÙŠØ¯</h3>

      <div style="display:flex;flex-direction:column;gap:12px">
        <div class="field">
        
          <input id="newFormName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬" />
        </div>

        <div class="field" >
          <input id="newFormSlug" placeholder="ramadan-requests" style="direction:ltr;text-align:left" hidden/>
        </div>

        <div id="newFormMsg" class="msg"></div>

        <div style="display:flex;gap:10px;justify-content:flex-start;margin-top:2px">
          <button class="btn primary" id="btnCreateForm" type="button">Ø¥Ù†Ø´Ø§Ø¡</button>
          <button class="btn" id="btnCloseModal" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>
    </div>
  </div>

<script>
  // ---------------- helpers ----------------
  function num(n){ return Number(n || 0).toLocaleString("en-US"); }
  function fmtDate(iso){
    try{
      const d = new Date(iso);
      return d.toLocaleString("en-US", {
        year:"numeric", month:"short", day:"2-digit",
        hour:"2-digit", minute:"2-digit", hour12:false
      });
    }catch(e){ return iso || "-" }
  }
  function statusBadge(status){
    const s = String(status || "").toLowerCase();
    if (s === "confirmed" || s === "received") return '<span class="status s-confirmed"><span class="sdot"></span>Confirmed</span>';
    if (s === "canceled" || s === "cancelled") return '<span class="status s-canceled"><span class="sdot"></span>Canceled</span>';
    return '<span class="status s-pending"><span class="sdot"></span>Pending</span>';
  }
  function formPublicLinkById(id){
    return `${location.origin}/?form_id=${encodeURIComponent(id)}`;
  }
  async function safeJson(res){
    const ct = (res.headers.get("content-type") || "").toLowerCase();
    const text = await res.text();
    if (!ct.includes("application/json")) throw new Error("NOT_JSON::" + text.slice(0, 160));
    return JSON.parse(text);
  }
  function showMsg(text, type="info"){
    const msg = document.getElementById("newFormMsg");
    msg.style.display = "block";
    msg.style.borderColor = "#e5e7eb";
    msg.style.background = "#fafafa";
    msg.style.color = "#111827";
    if(type === "err"){ msg.style.borderColor = "#fecaca"; msg.style.background="#fef2f2"; msg.style.color="#991b1b"; }
    if(type === "ok"){ msg.style.borderColor = "#bbf7d0"; msg.style.background="#ecfdf5"; msg.style.color="#166534"; }
    msg.textContent = text;
  }

  // ---------------- state ----------------
  let FORMS = [];
  let CURRENT_FORM_ID = null;

  function findForm(id){
    return FORMS.find(f => Number(f.id) === Number(id)) || null;
  }

  // ---------------- API ----------------
  async function apiMe(){
    const res = await fetch("/api/me", { credentials:"include", cache:"no-store" });
    if(!res.ok) return { name:"Ù…Ø³ØªØ®Ø¯Ù…", email:"" };
    const u = await res.json();
    const name = (u.name && u.name !== "Ù…Ø³ØªØ®Ø¯Ù…") ? u.name : (u.email ? u.email.split("@")[0] : "Ù…Ø³ØªØ®Ø¯Ù…");
    return { name, email: u.email || "" };
  }

  async function apiFormsList(){
    const res = await fetch("/api/forms-list", {
      credentials:"include",
      cache:"no-store",
      headers:{ "Accept":"application/json" }
    });
    const data = await safeJson(res);
    if(!res.ok || !data.ok) throw new Error(data.error || "FORMS_FAILED");
    return data.rows || [];
  }

  async function apiCreateForm(payload){
    const res = await fetch("/api/forms-create", {
      method:"POST",
      credentials:"include",
      cache:"no-store",
      headers:{ "Content-Type":"application/json", "Accept":"application/json" },
      body: JSON.stringify(payload)
    });
    const data = await safeJson(res);
    if(!res.ok || !data.ok) throw new Error(data.error || "CREATE_FAILED");
    return data.form;
  }

  async function apiDeleteForm(id){
    const res = await fetch("/api/forms-delete", {
      method:"POST",
      credentials:"include",
      cache:"no-store",
      headers:{ "Content-Type":"application/json", "Accept":"application/json" },
      body: JSON.stringify({ id })
    });
    const data = await safeJson(res);
    if(!res.ok || !data.ok) throw new Error(data.error || "DELETE_FAILED");
    return true;
  }

  async function apiStats(formId){
    const res = await fetch(`/api/stats?form_id=${encodeURIComponent(formId)}`, {
      credentials:"include",
      cache:"no-store",
      headers:{ "Accept":"application/json" }
    });
    const data = await safeJson(res);
    if(!res.ok) throw new Error(data.error || "STATS_FAILED");
    return data;
  }

  // ---------------- UI: modal ----------------
  function openModal(){
    document.getElementById("modalBack").style.display = "grid";
    document.getElementById("newFormMsg").style.display = "none";
    // Ù„Ø§ Ù†Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù‡Ù†Ø§
  }
  function closeModal(){
    document.getElementById("modalBack").style.display = "none";
  }

  // ---------------- UI: forms grid ----------------

  let DELETE_TARGET_ID = null;

function openDeleteModal(form){
  DELETE_TARGET_ID = Number(form.id);
  document.getElementById("deleteFormName").textContent = `${form.name}  (${form.slug})`;
  const back = document.getElementById("deleteBack");
  const msg = document.getElementById("deleteMsg");
  msg.style.display = "none";
  back.style.display = "grid";
}

function closeDeleteModal(){
  document.getElementById("deleteBack").style.display = "none";
  DELETE_TARGET_ID = null;
}

// wire modal once
(function wireDeleteModal(){
  const back = document.getElementById("deleteBack");
  const close = document.getElementById("btnDeleteClose");
  const cancel = document.getElementById("btnDeleteCancel");
  const confirmBtn = document.getElementById("btnDeleteConfirm");

  close.addEventListener("click", closeDeleteModal);
  cancel.addEventListener("click", closeDeleteModal);

  back.addEventListener("click", (e)=>{
    if(e.target === back) closeDeleteModal();
  });

  confirmBtn.addEventListener("click", async ()=>{
    const msg = document.getElementById("deleteMsg");
    if(!DELETE_TARGET_ID) return;

    confirmBtn.disabled = true;
    confirmBtn.style.opacity = "0.7";

    msg.style.display = "block";
    msg.style.background = "#fafafa";
    msg.style.borderColor = "#e5e7eb";
    msg.style.color = "#111827";
    msg.textContent = "Ø¬Ø§Ø±Ù Ø§Ù„Ø­Ø°Ù...";

    try{
      await apiDeleteForm(DELETE_TARGET_ID);

      // Ø§Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØ§Ø¹Ø±Ø¶Ù‡Ø§ ÙÙˆØ±Ø§Ù‹
      FORMS = FORMS.filter(f => Number(f.id) !== Number(DELETE_TARGET_ID));
      renderForms();

      msg.style.background = "#ecfdf5";
      msg.style.borderColor = "#bbf7d0";
      msg.style.color = "#166534";
      msg.textContent = "ØªÙ… Ø§Ù„Ø­Ø°Ù âœ…";

      setTimeout(closeDeleteModal, 350);
    }catch(e){
      msg.style.background = "#fef2f2";
      msg.style.borderColor = "#fecaca";
      msg.style.color = "#991b1b";
      msg.textContent = "ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: " + (e.message || e);
    }finally{
      confirmBtn.disabled = false;
      confirmBtn.style.opacity = "1";
    }
  });
})();

 function renderForms(){
  const grid = document.getElementById("formsGrid");

  const createCard = `
    <div class="form-card create-card" id="createCard">
      <div class="create-icon">+</div>
      <div class="form-title">Ø¥Ù†Ø´Ø§Ø¡ Ù†Ù…ÙˆØ°Ø¬</div>
    </div>
  `;

  const cards = FORMS.map(f => {
    return `
      <div class="form-card" data-card="${f.id}">
        <div class="form-title">${f.name}</div>
        <div class="form-slug">${f.slug}</div>

        <div class="actions" onclick="event.stopPropagation()">
          <button class="btn primary" data-open="${f.id}" type="button">ÙØªØ­</button>
          <button class="btn" data-copy="${f.id}" type="button">  Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
          <button class="btn danger" data-delete="${f.id}" type="button">Ø­Ø°Ù</button>
        </div>
      </div>
    `;
  }).join("");

  grid.innerHTML = createCard + (cards || `
    <div class="form-card" style="grid-column:span 8;cursor:default">
      <div class="form-title">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ù…Ø§Ø°Ø¬ Ø¨Ø¹Ø¯</div>
      <div class="create-hint">Ø§Ø¶ØºØ·ÙŠ â€œØ¥Ù†Ø´Ø§Ø¡ Ù†Ù…ÙˆØ°Ø¬â€ Ù„Ù„Ø¨Ø¯Ø¡.</div>
    </div>
  `);

  // âœ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ù…ÙˆØ°Ø¬
  document.getElementById("createCard").addEventListener("click", openModal);

  // âœ… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù†ÙØ³Ù‡Ø§ = ÙØªØ­ Ø§Ù„ÙÙˆØ±Ù… (Ø¨Ø¯ÙˆÙ† Panel)
 grid.querySelectorAll("[data-delete]").forEach(btn=>{
  btn.addEventListener("click", (e) => {
    e.stopPropagation(); // Ù…Ù‡Ù…: Ù„Ø§ ÙŠÙØªØ­ Ø§Ù„ÙÙˆØ±Ù… Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø­Ø°Ù
    const id = Number(btn.getAttribute("data-delete"));
    const form = FORMS.find(x => Number(x.id) === Number(id));
    if(!form) return;
    openDeleteModal(form);
  });
});


  // âœ… Ø²Ø± ÙØªØ­
  grid.querySelectorAll("[data-open]").forEach(btn=>{
    btn.addEventListener("click", () => {
      const id = btn.getAttribute("data-open");
      window.open(`/?form_id=${encodeURIComponent(id)}`, "_blank");
    });
  });

  // âœ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·
  grid.querySelectorAll("[data-copy]").forEach(btn=>{
    btn.addEventListener("click", async () => {
      const id = btn.getAttribute("data-copy");
      const link = formPublicLinkById(id);
      await navigator.clipboard.writeText(link);
      const old = btn.textContent;
      btn.textContent = "ØªÙ… âœ…";
      setTimeout(()=> btn.textContent = old, 900);
    });
  });

  // âœ… Ø­Ø°Ù
  grid.querySelectorAll("[data-delete]").forEach(btn=>{
    btn.addEventListener("click", async () => {
      const id = Number(btn.getAttribute("data-delete"));
      const f = FORMS.find(x => Number(x.id) === Number(id));
      if(!f) return;

      const ok = confirm(`ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù†Ù…ÙˆØ°Ø¬:\n${f.name}`);
      if(!ok) return;

      btn.disabled = true;
      try{
        await apiDeleteForm(id);
        FORMS = FORMS.filter(x => Number(x.id) !== Number(id));
        renderForms();
      }catch(e){
        alert("ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: " + (e.message || e));
      }finally{
        btn.disabled = false;
      }
    });
  });
}


  function pickInitialCurrent(){
    const saved = localStorage.getItem("current_form_id");
    const first = FORMS[0]?.id;
    CURRENT_FORM_ID = Number(saved || first || 0) || null;

    if (CURRENT_FORM_ID && !FORMS.some(f => Number(f.id) === Number(CURRENT_FORM_ID))) {
      CURRENT_FORM_ID = Number(first || 0) || null;
      localStorage.setItem("current_form_id", String(CURRENT_FORM_ID || ""));
    }
  }

  // ---------------- UI: panel ----------------
  function showPanel(){
    document.getElementById("panel").classList.add("show");
    document.getElementById("panel").scrollIntoView({ behavior:"smooth", block:"start" });
  }
  function hidePanel(){
    document.getElementById("panel").classList.remove("show");
  }

  function setTab(tab){
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.querySelector(`.tab[data-tab="${tab}"]`)?.classList.add("active");

    document.getElementById("tabEdit").style.display = (tab === "edit") ? "block" : "none";
    document.getElementById("tabStats").style.display = (tab === "stats") ? "block" : "none";
  }

  async function selectForm(id){
    const f = findForm(id);
    if(!f) return;

    CURRENT_FORM_ID = Number(id);
    localStorage.setItem("current_form_id", String(CURRENT_FORM_ID));

    renderForms();

    // header panel
    document.getElementById("panelTitle").textContent = f.name;
    document.getElementById("panelMeta").textContent = `ID: ${f.id} â€¢ ${f.slug}`;

    // panel buttons
    document.getElementById("btnOpenPublic").onclick = () => window.open(`/?form_id=${encodeURIComponent(f.id)}`, "_blank");
    document.getElementById("btnCopyPublic").onclick = async () => {
      await navigator.clipboard.writeText(formPublicLinkById(f.id));
      alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· âœ…");
    };
    document.getElementById("btnDeleteForm").onclick = async () => {
      const ok = confirm(`ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù†Ù…ÙˆØ°Ø¬:\n${f.name}`);
      if(!ok) return;
      try{
        await apiDeleteForm(f.id);
        FORMS = FORMS.filter(x => Number(x.id) !== Number(f.id));
        hidePanel();
        renderForms();
      }catch(e){
        alert("ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: " + (e.message || e));
      }
    };

    // default tab edit
    setTab("edit");
    showPanel();
  }

  // ---------------- UI: stats ----------------
  async function loadStats(){
    const f = findForm(CURRENT_FORM_ID);
    if(!f) return;

    document.getElementById("statsLoading").style.display = "block";
    document.getElementById("statsContent").style.display = "none";

    try{
      const data = await apiStats(f.id);

      document.getElementById("sTotal").textContent = num(data?.cards?.total ?? 0);
      document.getElementById("sConfirmed").textContent = num(data?.cards?.confirmed ?? 0);
      document.getElementById("sPending").textContent = num(data?.cards?.pending ?? 0);
      document.getElementById("sCanceled").textContent = num(data?.cards?.canceled ?? 0);

      const byCity = data.byCity || [];
      document.getElementById("cityHint").textContent = `Cities: ${num(byCity.length)}`;

      const citiesGrid = document.getElementById("citiesGrid");
      citiesGrid.innerHTML = byCity.map(c => {
        const total = Number(c.total || 0);
        const confirmed = Number(c.confirmed || 0);
        const percent = total ? Math.round((confirmed / total) * 100) : 0;
        return `
          <div class="city-card">
            <div class="city-name">${c.city || "-"}</div>
            <div class="circle" style="--p:${percent}">${percent}%</div>
            <div class="city-meta">
              <span>Confirmed: ${num(confirmed)}</span>
              <span>Total: ${num(total)}</span>
            </div>
          </div>
        `;
      }).join("");

      const latest = data.latest || [];
      document.getElementById("latestBody").innerHTML = latest.map(r => `
        <tr>
          <td data-label="#">${num(r.id)}</td>
          <td data-label="Ø§Ù„Ø§Ø³Ù…">${r.name || "-"}</td>
          <td data-label="Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©">${r.city || "-"}</td>
          <td data-label="Status">${statusBadge(r.status)}</td>
          <td data-label="Date">${fmtDate(r.created_at)}</td>
        </tr>
      `).join("");

      document.getElementById("statsLoading").style.display = "none";
      document.getElementById("statsContent").style.display = "block";
    }catch(e){
      document.getElementById("statsLoading").textContent = "ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª.";
      console.log(e);
    }
  }

  // ---------------- create form ----------------
  async function createForm(){
    const nameEl = document.getElementById("newFormName");
    const slugEl = document.getElementById("newFormSlug");
    const btn = document.getElementById("btnCreateForm");

    const name = nameEl.value.trim();
    const slug = slugEl.value.trim(); // Ø§Ø®ØªÙŠØ§Ø±ÙŠ

    if(!name){
      showMsg("Ø§ÙƒØªØ¨ÙŠ Ø§Ø³Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬.", "err");
      return;
    }

    btn.disabled = true;
    btn.style.opacity = "0.7";
    showMsg("Ø¬Ø§Ø±Ù Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬...", "info");

    try{
      const form = await apiCreateForm({ name, slug });

      // Ø£Ø¶ÙŠÙÙŠÙ‡ ÙÙˆØ±Ø§Ù‹ ÙƒØ£ÙˆÙ„ Ø¨Ø·Ø§Ù‚Ø© Ø¨Ø¹Ø¯ + (Ø¨Ø¯ÙˆÙ† Ù…Ø§ ÙŠÙ†ØªØ¸Ø± refresh)
      FORMS = [form, ...FORMS.filter(f => Number(f.id) !== Number(form.id))];

      CURRENT_FORM_ID = Number(form.id);
      localStorage.setItem("current_form_id", String(CURRENT_FORM_ID));

      renderForms();

      showMsg(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬: ${form.name}`, "ok");

      // Ø§ÙØªØ­ÙŠ Ø§Ù„ÙÙˆØ±Ù… Ù…Ø¨Ø§Ø´Ø±Ø©
      window.open(`/?form_id=${encodeURIComponent(form.id)}`, "_blank");

      // ØµÙÙ‘Ø±ÙŠ ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­
      nameEl.value = "";
      slugEl.value = "";
      setTimeout(closeModal, 300);

    }catch(e){
      const msg = String(e.message || e);

      if(msg.includes("NAME_EXISTS") || msg.includes("Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯") || msg.includes("DUPLICATE")){
        showMsg("Ø§Ø³Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹. Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ø³Ù… Ù…Ø®ØªÙ„Ù.", "err");
      }else if(msg.includes("SLUG_EXISTS")){
        showMsg("Ø§Ù„Ù€ Slug Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹. ØºÙŠÙ‘Ø±ÙŠÙ‡ Ø£Ùˆ Ø§ØªØ±ÙƒÙŠÙ‡ ÙØ§Ø¶ÙŠ.", "err");
      }else if(msg.startsWith("NOT_JSON::")){
        showMsg("Ø±Ø¬Ù‘Ø¹ ØµÙØ­Ø© HTML Ø¨Ø¯Ù„ JSON (ØºØ§Ù„Ø¨Ø§Ù‹ Cloudflare Access).", "err");
      }else{
        showMsg("ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬: " + msg, "err");
      }
    }finally{
      btn.disabled = false;
      btn.style.opacity = "1";
    }
  }

  // ---------------- boot ----------------
  (async function init(){
    // modal wiring
    document.getElementById("modalBack").addEventListener("click", (e)=>{ if(e.target.id === "modalBack") closeModal(); });
    document.getElementById("btnCloseModal").addEventListener("click", closeModal);
    document.getElementById("btnCreateForm").addEventListener("click", createForm);

    // tabs
    document.querySelectorAll(".tab").forEach(t => {
      t.addEventListener("click", async () => {
        const tab = t.getAttribute("data-tab");
        setTab(tab);
        if(tab === "stats"){
          await loadStats();
        }
      });
    });

    // header (user)
    const user = await apiMe();
    document.getElementById("hello").textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒØŒ ${user.name} ğŸ‘‹`;
    document.getElementById("updated").textContent = `Last update: ${new Date().toLocaleString("en-US")}`;
    document.getElementById("userEmail").textContent = user.email || "â€”";

    // load forms
    try{
      FORMS = await apiFormsList();
      pickInitialCurrent();
      renderForms();
    }catch(e){
      console.log(e);
      document.getElementById("formsGrid").innerHTML = `
        <div class="form-card create-card" id="createCard">
          <div class="create-icon">+</div>
          <div class="form-title">Ø¥Ù†Ø´Ø§Ø¡ Ù†Ù…ÙˆØ°Ø¬</div>
          <div class="create-hint">Ø§Ø¨Ø¯Ø¦ÙŠ Ù†Ù…ÙˆØ°Ø¬ Ø¬Ø¯ÙŠØ¯.</div>
        </div>
        <div class="form-card" style="grid-column:span 8;cursor:default">
          <div class="form-title">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬</div>
          <div class="create-hint">ØªØ£ÙƒØ¯ÙŠ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Cloudflare Access Ù„Ù…Ø³Ø§Ø± /api/forms-list</div>
        </div>
      `;
      document.getElementById("createCard").addEventListener("click", openModal);
      return;
    }

    // create card click
    document.getElementById("formsGrid").addEventListener("click", (e) => {
      const create = e.target.closest("#createCard");
      if (create) openModal();
    });

    // bind create card now (after first render)
    // (renderForms sets it too, but this is harmless)

  })();

</script>
<!-- DELETE MODAL -->
<div id="deleteBack" style="position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;place-items:center;padding:18px;z-index:9999">
  <div style="width:min(520px,100%);background:#fff;border-radius:18px;padding:16px;border:1px solid #e5e7eb;box-shadow:0 10px 24px rgba(17,24,39,.10)">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px">
      <h3 style="margin:0;font-weight:900">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h3>
      <button id="btnDeleteClose" type="button"
        style="border:0;background:transparent;cursor:pointer;font-size:20px;line-height:1">Ã—</button>
    </div>

    <div style="display:flex;gap:12px;align-items:flex-start">
      <div style="width:44px;height:44px;border-radius:14px;display:grid;place-items:center;background:#fef2f2;border:1px solid #fee2e2;color:#b91c1c;font-weight:900">
        !
      </div>

      <div style="flex:1">
        <div style="font-weight:900;margin-bottom:6px">
          Ù‡Ù„ Ø£Ù†ØªÙ Ù…ØªØ£ÙƒØ¯Ø© Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ØŸ
        </div>
        <div id="deleteFormName" style="color:#6b7280;font-weight:800"></div>

        <div style="margin-top:12px;color:#991b1b;font-weight:800;font-size:13px">
          âš ï¸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙˆØ±Ø¨Ù…Ø§ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© (Ø­Ø³Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª).
        </div>
      </div>
    </div>

    <div id="deleteMsg" style="display:none;margin-top:12px;padding:10px;border-radius:12px;border:1px solid #e5e7eb;background:#fafafa;font-weight:900"></div>

    <div style="display:flex;gap:10px;justify-content:flex-start;margin-top:14px">
      <button class="btn danger" id="btnDeleteConfirm" type="button">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button>
      <button class="btn" id="btnDeleteCancel" type="button">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

</body>
</html>
