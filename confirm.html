<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>تأكيد الاستلام</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    body{margin:0;font-family:Tajawal,system-ui;background:#f6f7fb;color:#111827}
    .wrap{min-height:100vh;display:grid;place-items:center;padding:18px}
    .card{width:min(520px,100%);background:#fff;border:1px solid #e5e7eb;border-radius:18px;box-shadow:0 10px 24px rgba(17,24,39,.06);padding:18px}
    h1{margin:0 0 6px;font-size:20px;font-weight:800}
    p{margin:0 0 14px;color:#6b7280;font-weight:700;font-size:14px;line-height:1.8}
    .btns{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:14px}
    button{border:0;border-radius:14px;padding:12px 14px;font-weight:900;cursor:pointer}
    .ok{background:#16a34a;color:#fff}
    .no{background:#ef4444;color:#fff}
    .ghost{background:#f3f4f6;color:#111827}
    .state{margin-top:12px;padding:12px;border-radius:14px;background:#f8fafc;border:1px dashed #e5e7eb;color:#111827;font-weight:800;display:none}
    .modal-back{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;place-items:center;padding:18px}
    .modal{width:min(420px,100%);background:#fff;border-radius:18px;padding:16px;border:1px solid #e5e7eb}
    .modal h2{margin:0 0 6px;font-size:16px;font-weight:900}
    .modal .mbtns{display:flex;gap:10px;justify-content:flex-start;margin-top:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>تأكيد الاستلام</h1>
      <p id="hint">اضغط تأكيد أو إلغاء. بعد اختيارك لن تستطيع التعديل مرة أخرى.</p>

      <div class="btns">
        <button class="ok" id="btnConfirm">تأكيد ✅</button>
        <button class="no" id="btnCancel">إلغاء ❌</button>
      </div>

      <div class="state" id="stateBox"></div>

      <button class="ghost" style="margin-top:10px;width:100%" onclick="location.href='/'">العودة للفورم</button>
    </div>
  </div>

  <div class="modal-back" id="modalBack">
    <div class="modal">
      <h2 id="mTitle">هل أنت متأكد؟</h2>
      <p id="mText" style="margin:0;color:#6b7280;font-weight:700;line-height:1.8">—</p>
      <div class="mbtns">
        <button class="ok" id="mYes">نعم</button>
        <button class="ghost" id="mNo">لا</button>
      </div>
    </div>
  </div>

<script>
  const token = new URLSearchParams(location.search).get("token");
  const stateBox = document.getElementById("stateBox");
  const modalBack = document.getElementById("modalBack");
  const mTitle = document.getElementById("mTitle");
  const mText = document.getElementById("mText");
  const mYes = document.getElementById("mYes");
  const mNo = document.getElementById("mNo");

  if(!token){
    showState("الرابط غير صالح أو غير مكتمل (لا يوجد token).", true);
    disableAll();
  }

  let pendingAction = null;

  document.getElementById("btnConfirm").onclick = () => openModal("confirm");
  document.getElementById("btnCancel").onclick  = () => openModal("cancel");

  function openModal(action){
    pendingAction = action;
    if(action === "confirm"){
      mTitle.textContent = "تأكيد الاستلام";
      mText.textContent = "هل أنت متأكد أنك تريد تأكيد الاستلام؟";
      mYes.className = "ok";
      mYes.textContent = "نعم، أكد";
    }else{
      mTitle.textContent = "إلغاء الطلب";
      mText.textContent = "هل أنت متأكد أنك تريد إلغاء الطلب؟";
      mYes.className = "no";
      mYes.textContent = "نعم، إلغاء";
    }
    modalBack.style.display = "grid";
  }

  mNo.onclick = () => { modalBack.style.display = "none"; pendingAction = null; };

  mYes.onclick = async () => {
    if(!token || !pendingAction) return;

    modalBack.style.display = "none";
    showState("جاري حفظ قرارك...", false);

    const res = await fetch("/api/decide", {
      method: "POST",
      headers: {"content-type":"application/json"},
      body: JSON.stringify({ token, action: pendingAction })
    });

    const data = await res.json().catch(()=> ({}));

    if(res.status === 200){
      if(data.decision === "confirmed") showState("✅ تم تأكيد الاستلام بنجاح. شكراً لك.", false);
      else showState("❌ تم إلغاء الطلب. شكراً لتوضيحك.", false);

      disableAll();
      return;
    }

    if(res.status === 409){
      // already decided
      const d = data.decision;
      if(d === "confirmed") showState("✅ هذا الرابط تم تأكيده مسبقاً ولا يمكن تغييره.", false);
      else if(d === "cancelled") showState("❌ هذا الرابط تم إلغاؤه مسبقاً ولا يمكن تغييره.", false);
      else showState("تم اتخاذ قرار مسبقاً ولا يمكن التعديل.", false);

      disableAll();
      return;
    }


    showState("حدث خطأ: الرابط غير صالح أو غير موجود.", true);
  };

  let submitting = false;
//new
  mYes.onclick = async () => {
    if (submitting) return;
    submitting = true;
  
    disableAll();
    mYes.disabled = true;
    mNo.disabled = true;
  
  };
  

  function showState(msg, isErr){
    stateBox.style.display = "block";
    stateBox.style.borderColor = isErr ? "#fecaca" : "#e5e7eb";
    stateBox.style.background = isErr ? "#fff1f2" : "#f8fafc";
    stateBox.textContent = msg;
  }

  function disableAll(){
    document.getElementById("btnConfirm").disabled = true;
    document.getElementById("btnCancel").disabled  = true;
    document.getElementById("btnConfirm").style.opacity = .6;
    document.getElementById("btnCancel").style.opacity  = .6;
  }
</script>
</body>
</html>
